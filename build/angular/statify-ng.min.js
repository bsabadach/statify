//
// statify - v0.2.1
// The MIT License
// Copyright (c) 2014 Boris Sabadach <boris@washmatique.fr> 
//
var statify=function(a){"use strict";var b=a.document,c=a.console,d=a.CSSStyleRule,e=a.CSSRule,f=a.setTimeout,g={};g.VERSION="0.1.0",g.ns="washm.statify",g.config={attr:{states:"data-states",inc:"data-states-inc",exc:"data-states-exc"},optionsAttr:{initial:"data-states-initial",keepLayout:"data-states-keepLayout",includeRoot:"data-states-includeRoot",deepFetch:"data-states-deepFetch",reverseTrans:"data-states-reverseTrans"},cssModifier:"--",triggerFn:"trigger"},g.DEBUG=!1,g._debug=function(){var a=[].join,b=c&&c.log;return function(){return b&&g.DEBUG&&c.log(a.call(arguments,","))}}();var h=function(a){return function(){g._debug(a+"  is not implemented")}},i=["isFunction","isArray","find","indexOf","each","difference","keys","isObject","extend","bind"];g._={};for(var j in i)g._[i[j]]=h(i[j]);return"function"!=typeof String.prototype.trim&&(String.prototype.trim=g._.trim||g.$.trim),g.CSS=function(a,b){var f=!0,g={},h=["screen","all",""],i={};return{transitions:function(){var b,c=a.createElement("div"),d=["transition","OTransition","MSTransition","MozTransition","WebkitTransition"],e=c.style;for(var f in d)if(void 0!==e[d[f]]){b=d[f];break}return void 0!==b&&{durationProp:b+"Duration",delayProp:b+"Delay"}}(),_acceptSheet:function(a){var c=b._,d=a.media.mediaText;return d=d.split(","),void 0!==c.find(d,function(a){return c.indexOf(h,a.trim())>=0})},_ruleHasSelector:function(a,c){var d=b._,e=a.selectorText.split(",");return!!d.find(e,function(a){return a.trim()===c})},_findStyleInRules:function(a,c){var f=this,g=b._,h=g.find(a,function(a){return(a.constructor===d||a.constructor===e)&&f._ruleHasSelector(a,c)});return void 0===h?null:h.style},findStyle:function(b){if(f&&void 0!==g[b])return g[b];var d=a.styleSheets;if(f=void 0===d)return null;for(var e,h,i,j=0,k=d.length;k>j;j++)try{if(e=d[j],!e||!this._acceptSheet(e))continue;if(h=e.rules||e.cssRules,null===h)continue;if(i=this._findStyleInRules(h,b),null!==i)return g[b]=i,i}catch(l){if(c.log(l.message),"SecurityError"===l.name)continue;throw l}return g[b]="empty",g[b]},hasRule:function(a){return"empty"!==this.findStyle(a)},getMillis:function(a){var c,d=a.split(","),e=0,f=b._;return f.each(d,function(a){c=parseFloat(a.replace("s","").replace("m","")),e=Math.max(e,isNaN(c)?0:c*(-1===a.indexOf("ms")?1e3:1))}),e},getFullDuration:function(a){if(!this.transitions)return 0;var b=this;return i[a]||function(){if(!b.hasRule(a))return i[a]=0,0;var c=b.findStyle(a),d=b.getMillis(c[b.transitions.durationProp])+b.getMillis(c[b.transitions.delayProp]);return i[a]=d,d}()}}}(b,g),g.EXIT="state:exit",g.EXITED="state:exited",g.ENTER="state:enter",g.CHANGED="state:changed",function(a){var b=a.CSS,c=a.config,d=[{type:"display",yes:"block",no:"none"},{type:"visibility",yes:"visible",no:"hidden"}],e=function(a,b){if(this.$el=a,this.display=d[b?1:0],!b){var c=a.css(this.display.yes);c&&(this.display.yes=c)}this.configure()};e.prototype={configure:function(){return void 0===this.$el.attr("class")?void(this.hasDeclaredStyle=!1):(this.hasDeclaredStyle=!0,void(this.baseStyle=this.$el.attr("class").split(" ").pop()))},isDisplayed:function(){return this.$el.css(this.display.type)!==this.display.no},toggle:function(){this.$el.css(this.display.type,this.isDisplayed()?this.display.no:this.display.yes)},removeStateStyle:function(a){if(this.hasDeclaredStyle){var b=this.baseStyle+c.cssModifier+a;b&&this.$el.hasClass(b)&&this.$el.removeClass(b)}},addStateStyle:function(a){if(this.hasDeclaredStyle){var c=this.getStyleSelector(a);b.hasRule(c)&&this.$el.addClass(c.replace(".",""))}},getStyleSelector:function(a){return this.hasDeclaredStyle?"."+this.baseStyle+c.cssModifier+a:null}},a.ViewStateElement=e}(g),function(a){var b=a.ViewStateElement,c=function(a,b,c){this.$el=b,this.name=a,this.keepLayout=c,this.transDuration=-1,this.inclusions=[],this.exclusions=[]};c.prototype={addElement:function(a,c){(c?this.inclusions:this.exclusions).push(new b(a,this.keepLayout))},exit:function(){var b=a._;b.each(this.inclusions,function(a){a.removeStateStyle(this.name)},this)},enter:function(){var b=a._;b.each(this.exclusions,function(a){this._update(a,!1)},this),b.each(this.inclusions,function(a){this._update(a,!0)},this)},_update:function(a,b){b!==a.isDisplayed()&&a.toggle(),b&&a.addStateStyle(this.name)}},a.ViewState=c}(g),function(a){var b=function(a,b){this.client=a.client,this.states=a.states,this.initialize(b)};b.prototype={initialize:function(){this.nextState=this.currentState=null},notifyClient:function(a,b){this.client.trigger(a,b)},setState:function(a){this.ensureState(a),this.nextState=this.states[a],this.exitCurrent(),this.enterNext()},ensureState:function(a){if(void 0===this.states[a])throw new Error("unknown state:-"+a+"-")},exitCurrent:function(){this.currentState&&this.nextState!==this.currentState.name&&this.currentState.exit()},enterNext:function(){this.nextState.enter(),this.currentState=this.nextState,this.afterNextEntered()},afterNextEntered:function(){this.nextState=null,this.client.currentState=this.currentState,this.notifyClient(a.CHANGED,this.currentState.name)}},a.ViewStatesManager=b}(g),function(a){var b=a.CSS;if(b.transitions){var c=function(){this.initialize()};c.prototype={initialize:function(){a._;this.isPlaying=!1,this.callBack=null;var b=this;this.onComplete=function(){b.callBack(),b.isPlaying=!1}},playOn:function(a){this._startOn(a,!1)},reverseOn:function(a){this._startOn(a,!0)},_startOn:function(a,b){this.isPlaying=!0;var c=this._getTotalDuration(a);this._start(a,c,this.onComplete,b)},_start:function(a,b,c,d){return d?a.exit():a.enter(),0===b?void c():void f(c,b)},_getTotalDuration:function(c){if(c.transDuration>=0)return c.transDuration;var d=0,e=a._;return e.each(c.inclusions,function(a){d=Math.max(b.getFullDuration(a.getStyleSelector(c.name)),d)}),c.transDuration=d,d}},a.ViewStateTransition=c;var d=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};d(a.ViewStatesManager.prototype,{initialize:function(b){this.reverseTrans=b.reverseTrans,this.transition=new c;var d=a._;this.onCurrentExited=d.bind(this.enterNext,this),this.completeCallBack=d.bind(this.afterNextEntered,this)},setState:function(a){this.transition.isPlaying||(this.ensureState(a),this.nextState=this.states[a],this.nextState!==this.currentState&&this.exitCurrent())},exitCurrent:function(){return this.currentState?(this.notifyClient(a.EXIT,this.currentState.name),void(this.reverseTrans?(this.transition.callBack=this.onCurrentExited,this.transition.reverseOn(this.currentState)):(this.currentState.exit(),this.enterNext()))):void this.enterNext()},enterNext:function(){this.currentState&&this.notifyClient(a.EXITED,this.currentState.name),this.notifyClient(a.ENTER,this.nextState.name),this.transition.callBack=this.completeCallBack,this.transition.playOn(this.nextState)},afterNextEntered:function(){this.currentState=this.nextState,this.notifyClient(a.CHANGED,this.currentState.name)}})}}(g),g.buildViewStates=function(a){function b(a){a=a.split(",");for(var b,c={};b=a.shift();){if(b=b.trim(),c[b])throw new Error("the state "+b+" is declared twice");c[b]=null}return c}function c(b,c){var d,e,f,g=c.container,h=a._,i=a.ViewState,j=function(a,b,c,d,e,f){if(b=b.trim(),""===b)throw new Error("declared state on a child of "+c.selector+" has an empty name");a[b]=a[b]||new i(b,c,e),a[b].addElement(d,f)},k=function(b,c,d,e,f,g){var h=a._;h.each(c,function(a){j(b,a,d,e,f,g)}),h.each(h.difference(h.keys(b),c),function(a){j(b,a,d,e,f,!g)})};h.each(c.elements,function(a){d=a.$el,f=void 0!==a.inc,e=f?a.inc:a.exc,void 0!==e&&(e="all"===e.trim()?c.names:e.trim(),k(b,e.split(","),g,d,c.keepLayout,f))}),c.includeRoot&&h.each(c.names.split(","),function(a){j(b,a,g,g,c.keepLayout,!0)})}return function(a){var d=b(a.names);return c(d,a),d}}(g),g.buildStatesContext=function(a){function b(b,c){var d,e=[],f=a._,g=a.$;return f.each(c,function(a){f.isObject(a.$el)||(d=g(a.el,b),a.$el=d,"el"in a&&delete a.el),e.push(a)}),e}function c(b,c){var f,g,h,i,j=[],k=a._,l=a.$;return k.each([e.exc,e.inc],function(a){g=d(b,a,c),f=a.replace(e.states+"-",""),k.each(g,function(b){i=l(b),h=k.find(j,function(a){return a.$el===i})||{$el:i},h[f]=i.attr(a).trim(),j.push(h)})}),j}function d(a,b,c){return c?a.find("["+b+"]"):a.children("["+b+"]")}var e=a.config.attr,f=a.config.optionsAttr,g={includeRoot:!1,keepLayout:!0,deepFetch:!1,reverseTrans:!1},h={"false":!1,"true":!0};return function(d,i){if(!d||0===d.size)throw new Error("cannot build states on an unknown element");var j=a._,k={};if(i=i||{},k.names=i.names||d.attr(e.states),void 0===k.names)throw new Error(d.selector+" has no state declared");return k.container=d,j.extend(k,g),j.extend(k,i),k.initialState=i.initialState?i.initialState:k.names.split(",")[0],j.each(j.keys(f),function(a){var b=d.attr(f[a]);void 0!==b&&(b=""===b?!0:h[b.toLowerCase()],k[a]=b)}),k.elements=j.isArray(i.elements)?b(d,k.elements):c(d,k.deepFetch),k.container=k.container||d,k}}(g),g.StatesClientMixin=function(a){var b=a.buildStatesContext,c=a.buildViewStates,d=a.ViewStatesManager,e=a.config,f=[a.EXIT,a.EXITED,a.ENTER,a.CHANGED],g=function(){this.currentState=null,this.applyDefaults(),this.statesContext=b(this.$el,this.options);var a=c(this.statesContext);this.manageStates(a),this.setState(this.statesContext.initialState)},h=function(){var b=a._;this.options=this.options||{},void 0!==this.statesDefaults&&b.extend(this.options,this.statesDefaults)},i=function(b){var c=a._,e={reverseTrans:this.statesContext.reverseTrans};this.stateManager=new d({client:this,states:b},e),this.$el.on(f.join(" "),c.bind(this.onStateEvent,this))},j=function(a){this.stateManager.setState(a)},k=function(b,c){var d=a._,f=this.$el[e.triggerFn];return d.isFunction(f)?void f.call(this.$el,b,c):void this.onStateEvent(b,c)},l=function(b,c){a._debug(this.$el+" "+(b.type||b)+" "+c)},m=function(){this.currentState=null,this.$el.off(f.join(" ")),delete this.stateManager};return{initializeStates:g,applyDefaults:h,manageStates:i,setState:j,onStateEvent:l,trigger:k,disposeStates:m}}(g),g}(this);!function(a){"use strict";function b(a,b){this.addStateElement=function(a,b,c){var e={};e.$el=a,e[b]=c,d.push(e)};var c=a;j.extend(c,b.StatesClientMixin),a.$parent.setState=function(a){c.setState(a)},c.onStateEvent=function(b,c){a.$emit(b,c)},c.options={};var d=c.options.elements=[];a.$on("$destroy",function(){c.disposeStates()})}function c(a,b,c){var d=a;d.options.names=c.states,d.options.initialState=d.options.names.split(",")[0],d.$el=j.element(b),d.statesOptions={},d.initializeStates()}function d(a){var b="states"+a.substring(0,1).toUpperCase()+a.substring(1,a.length);return{name:b,require:"^"+e.name,restrict:"A",transclude:!1,link:function(c,d,e,f){f.addStateElement(d,a,e[b])}}}var e,f,g,h=a.require,i=a._,j=a.angular,k=a.statify;e={restrict:"A",transclude:!1,scope:{},name:k.config.attr.states.replace("data-",""),controller:b,link:c},f=d("inc"),g=d("exc"),j.module("statify-ng",[]).directive(e.name,function(){return e}).directive(f.name,function(){return f}).directive(g.name,function(){return g}).factory("ngStatity",function(){return k}),k.$=j.element,i||void 0===h||(i=h("underscore")),k._=i||{isFunction:j.isFunction,isArray:j.isArray,each:j.forEach,isObject:j.isObject,extend:j.extend,find:function(a,b,c){var d;return this.each(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},indexOf:function(a,b){if(a.indexOf&&[].indexOf===a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1},difference:function(a,b){var c=[],d=this;return this.each(a,function(a){-1===d.indexOf(b,a)&&c.push(a)}),c},keys:function(a){if(!a)return[];var b=[];return this.each(a,function(a,c){b.push(c)}),b},bind:function(a,b,c){return j.bind(b,a,c)}}}(this);