var statify=function(a){"use strict";var b=a.document,c=a.console,d=a.CSSStyleRule,e=a.CSSRule,f=a.setTimeout,g={};g.VERSION="0.1.0",g.ns="washm.statify",g.config={stateAttr:"data-states",inAttr:"data-states-inc",outAttr:"data-states-exc",cssModifier:"-",triggerFunction:"trigger"},g.DEBUG=!0,g._debug=function(){var a=[].join,b=c&&c.log;return function(){return b&&g.DEBUG&&c.log(a.call(arguments,","))}}();var h=function(a){return function(){g._debug(a+"  is not implemented")}},i=["isFunction","isArray","find","indexOf","each","difference","keys","isObject","extend","bind"];g._={};for(var j in i)g._[i[j]]=h(i[j]);return g.DEBUG=!0,"function"!=typeof String.prototype.trim&&(String.prototype.trim=g._.trim||g.$.trim),g.CSS=function(a,b){var f=!0,g={},h=["screen","all",""],i={};return{transitions:function(){var b,c=a.createElement("div"),d=["transition","OTransition","MSTransition","MozTransition","WebkitTransition"],e=c.style;for(var f in d)if(void 0!==e[d[f]]){b=d[f];break}return void 0!==b&&{durationProp:b+"Duration",delayProp:b+"Delay"}}(),_acceptSheet:function(a){var c=b._,d=a.media.mediaText;return d=d.split(","),void 0!==c.find(d,function(a){return c.indexOf(h,a.trim())>=0})},_ruleHasSelector:function(a,c){var d=b._,e=a.selectorText.split(",");return!!d.find(e,function(a){return a.trim()===c})},_findStyleInRules:function(a,c){var f=this,g=b._,h=g.find(a,function(a){return(a.constructor===d||a.constructor===e)&&f._ruleHasSelector(a,c)});return void 0===h?null:h.style},findStyle:function(b){if(f&&void 0!==g[b])return g[b];var d=a.styleSheets;if(f=void 0===d)return null;for(var e,h,i,j=0,k=d.length;k>j;j++)try{if(e=d[j],!e||!this._acceptSheet(e))continue;if(h=e.rules||e.cssRules,null===h)continue;if(i=this._findStyleInRules(h,b),null!==i)return g[b]=i,i}catch(l){if(c.log(l.message),"SecurityError"===l.name)continue;throw l}return g[b]="empty",g[b]},hasRule:function(a){return"empty"!==this.findStyle(a)},getMillis:function(a){var c,d=a.split(","),e=0,f=b._;return f.each(d,function(a){c=parseFloat(a.replace("s","").replace("m","")),e=Math.max(e,isNaN(c)?0:c*(-1===a.indexOf("ms")?1e3:1))}),e},getFullDuration:function(a){if(!this.transitions)return 0;var b=this;return i[a]||function(){if(!b.hasRule(a))return i[a]=0,0;var c=b.findStyle(a),d=b.getMillis(c[b.transitions.durationProp])+b.getMillis(c[b.transitions.delayProp]);return i[a]=d,d}()}}}(b,g),g.EXIT="state:exit",g.EXITED="state:exited",g.ENTER="state:enter",g.CHANGED="state:changed",function(a){var b=a.CSS,c=a.config,d=[{type:"display",yes:"block",no:"none"},{type:"visibility",yes:"visible",no:"hidden"}],e=function(a,b){if(this.$el=a,this.display=d[b?1:0],!b){var c=a.css(this.display.yes);c&&(this.display.yes=c)}this.ensure()};e.prototype={ensure:function(){if(void 0===this.$el.attr("class"))throw new Error(this.$el.selector+" element(s) must have at least a base style class");this.baseStyle=this.$el.attr("class").split(" ").pop()},isDisplayed:function(){return this.$el.css(this.display.type)!==this.display.no},toggle:function(){this.$el.css(this.display.type,this.isDisplayed()?this.display.no:this.display.yes)},removeStateStyle:function(a){var b=this.baseStyle+c.cssModifier+a;b&&this.$el.hasClass(b)&&this.$el.removeClass(b)},addStateStyle:function(a){var c=this.getStyleSelector(a);b.hasRule(c)&&this.$el.addClass(c.replace(".",""))},getStyleSelector:function(a){return"."+this.baseStyle+c.cssModifier+a}},a.ViewStateElement=e}(g),function(a){var b=a.ViewStateElement,c=function(a,b,c){this.$el=b,this.name=a,this.keepLayout=c,this.transDuration=-1,this.inclusions=[],this.exclusions=[]};c.prototype={addElement:function(a,c){(c?this.inclusions:this.exclusions).push(new b(a,this.keepLayout))},exit:function(){var b=a._;b.each(this.inclusions,function(a){a.removeStateStyle(this.name)},this)},enter:function(){var b=a._;b.each(this.exclusions,function(a){this._update(a,!1)},this),b.each(this.inclusions,function(a){this._update(a,!0)},this)},_update:function(a,b){b!==a.isDisplayed()&&a.toggle(),b&&a.addStateStyle(this.name)}},a.ViewState=c}(g),function(a){var b=function(a,b){this.client=a.client,this.states=a.states,this.initialize(b)};b.prototype={initialize:function(a){this.silent=a.silent,this.nextState=this.currentState=null},notifyClient:function(a,b){this.silent||this.client.trigger(a,b)},setState:function(a){this.ensureState(a),this.nextState=this.states[a],this.exitCurrent(),this.enterNext()},ensureState:function(a){if(void 0===this.states[a])throw new Error("unknown state:-"+a+"-")},exitCurrent:function(){this.currentState&&this.nextState!==this.currentState.name&&this.currentState.exit()},enterNext:function(){this.nextState.enter(),this.currentState=this.nextState,this.afterNextEntered()},afterNextEntered:function(){this.nextState=null,this.client.currentState=this.currentState,this.notifyClient(a.CHANGED,this.currentState.name)}},a.ViewStatesManager=b}(g),function(a){var b=a.CSS;if(b.transitions){var c=function(){this.initialize()};c.prototype={_startOn:function(a,b){this.isPlaying=!0;var c=this._getTotalDuration(a);this._start(a,c,this.onComplete,b)},_onComplete:function(){this.callBack(),this.isPlaying=!1},_start:function(a,b,c,d){return d?a.exit():a.enter(),0===b?(c(),void 0):(f(c,b),void 0)},_getTotalDuration:function(c){if(c.transDuration>=0)return c.transDuration;var d=0,e=a._;return e.each(c.inclusions,function(a){d=Math.max(b.getFullDuration(a.getStyleSelector(c.name)),d)}),c.transDuration=d,d},initialize:function(){var b=a._;this.isPlaying=!1,this.callBack=null,this.onComplete=b.bind(this._onComplete,this)},playOn:function(a){this._startOn(a,!1)},reverseOn:function(a){this._startOn(a,!0)}},g.ViewStateTransition=c;var d=a._,e=function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])};e(a.ViewStatesManager.prototype,{initialize:function(a){this.reverseTransitions=a.reverseTransitions,this.transition=new c,this.onCurrentExited=d.bind(this.enterNext,this),this.completeCallBack=d.bind(this.afterNextEntered,this)},setState:function(a){this.transition.isPlaying||(this.ensureState(a),this.nextState=this.states[a],this.nextState!==this.currentState&&this.exitCurrent())},exitCurrent:function(){return this.currentState?(this.notifyClient(a.EXIT,this.currentState.name),this.reverseTransitions?(this.transition.callBack=this.onCurrentExited,this.transition.reverseOn(this.currentState)):(this.currentState.exit(),this.enterNext()),void 0):(this.enterNext(),void 0)},enterNext:function(){this.currentState&&this.notifyClient(a.EXITED,this.currentState.name),this.notifyClient(a.ENTER,this.nextState.name),this.transition.callBack=this.completeCallBack,this.transition.playOn(this.nextState)},afterNextEntered:function(){this.currentState=this.nextState,this.notifyClient(a.CHANGED,this.currentState.name)}})}}(g),g.buildViewStates=function(a){var b=a.ViewState,c=function(a){a=a.split(",");for(var b,c={};b=a.shift();){if(b=b.trim(),c[b])throw new Error("the state "+b+" is declared twice");c[b]=null}return c},d=function(a,c,d,e,f,g){if(c=c.trim(),""===c)throw new Error("declared state on a child of "+d.selector+" has an empty name");a[c]=a[c]||new b(c,d,f),a[c].addElement(e,g)},e=function(b,c,e,f,g,h){var i=a._;i.each(c,function(a){d(b,a,e,f,g,h)}),i.each(i.difference(i.keys(b),c),function(a){d(b,a,e,f,g,!h)})},f=function(b,c){var f,g,h,i=c.container,j=a._;j.each(c.elements,function(a){f=a.$el,h=void 0!==a.inc,g=h?a.inc:a.exc,void 0!==g&&(g="all"===g.trim()?c.names:g.trim(),e(b,g.split(","),i,f,c.keepLayout,h))}),c.includeRoot&&j.each(c.names.split(","),function(a){d(b,a,i,i,c.keepLayout,!0)})};return function(a){var b=c(a.names);return f(b,a),b}}(g),g.buildStatesContext=function(a){var b=a.config,c={includeRoot:!1,keepLayout:!0,deepFetch:!1,reverseTransitions:!1,silent:!1},d=function(a,b,c){return c?a.find("["+b+"]"):a.children("["+b+"]")},e=function(c,e){var f,g,h,i,j=[],k=e.deepFetch,l=a._,m=a.$;return l.each([b.outAttr,b.inAttr],function(a){g=d(c,a,k),f=a.replace(b.stateAttr+"-",""),l.each(g,function(b){i=m(b),h=l.find(j,function(a){return a.$el===i})||{$el:i},h[f]=i.attr(a).trim(),j.push(h)})}),j};return function(d,f){if(!d||0===d.size)throw new Error("cannot build states on an unknown element");var g=a._,h={};if(h.names=f.names||d.attr(b.stateAttr),void 0===h.names)throw new Error(d.selector+" has no state declared");return h.container=d,g.extend(h,c),g.extend(h,f),h.initialState=f.initialState?f.initialState:h.names.split(",")[0],h.elements=g.isObject(f.elements)?f.elements:e(d,f),h.container=h.container||d,h}}(g),g.StatesClient=function(a){var b=a.buildStatesContext,c=a.buildViewStates,d=a.ViewStatesManager,e=a.config,f=[a.EXIT,a.EXITED,a.ENTER,a.CHANGED],h=function(){this.currentState=null,this.applyDefaults(),this.statesContext=b(this.$el,this.options);var a=c(this.statesContext);this.manageStates(a),this.setState(this.statesContext.initialState)},i=function(){var b=a._;this.options=this.options||{},void 0!==this.statesDefaults&&b.extend(this.options,this.statesDefaults)},j=function(b){var c=a._;this.stateManager=new d({client:this,states:b},this.options),this.$el.on(f.join(" "),c.bind(this.onStateEvent,this))},k=function(a){this.stateManager.setState(a)},l=function(b,c){var d=a._;return d.isFunction(this.$el[e.triggerFunction])?(this.$el[e.triggerFunction].call(this.$el,b,c),void 0):(this.onStateEvent(b,c),void 0)},m=function(a,b){g._debug(this.$el+" "+(a.type||a)+" "+b)},n=function(){this.currentState=null,this.$el.off(f.join(" ")),delete this.stateManager};return{initializeStates:h,applyDefaults:i,manageStates:j,setState:k,onStateEvent:m,trigger:l,disposeStates:n}}(g),g}(this);!function(a,b,c){"use strict";c.$=a.$,c._=a._,b.View.statify=function(a){var b=a.extend({initialize:function(){var b=[].slice.call(arguments,1);a.prototype.initialize.call(this,b),this.statesOptions=b[0].states},render:function(){var b=a.prototype.render.call(this);return this.initializeStates(),b}});return _.extend(b.prototype,c.StatesClient),b},b.StatifiedView=b.View.statify(b.View)}(this,Backbone,statify);